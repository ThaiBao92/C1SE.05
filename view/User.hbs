<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-1BmE4kWBq78iYhFldvKuhfTAU6auU8tT94WrHftjDbrCEXSU1oBoqyl2QvZ6jIW3" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.1/css/all.min.css" />
    <link rel="stylesheet" href="style.css">
    <script src="Login.js"></script>
</head>
<body>
    <div class="userpage" id="userpage">
        <div class="userpage-header container">
            <img src="/img/logo.png" class="img-logo">
            <div class="userpage-header-search">
                <input type="search" class="form-control" id="floatingSearch"
                    placeholder="Search for something here...">
                <i class="fa-solid fa-magnifying-glass"></i>
            </div>
        </div>
        <div class="userpage-body">
            <div class="userpage-body-left">
                <ul class="nav nav-pills  d-flex flex-column">
                    <li class="nav-item  ">
                        <a class="nav-link d-flex flex-row  "  href="/">
                            <div class="home">
                                <i class="fa-solid fa-house"></i>
                            </div>
                            Home
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex flex-row" href="/user">
                            <div class="user">
                                <i class="fa-solid fa-user"></i>
                            </div>
                            User
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link d-flex flex-row" href="/notification">
                            <div class="notification">
                                <i class="fa-solid fa-bell"></i>
                                <span class="noti_alert">0</span>
                            </div>
                            Notification
                        </a>
                    </li>
                    <li class="nav-item">
                        <a  style="cursor: pointer" class="nav-link d-flex flex-row logout-btn">
                            <div class="logout">
                                <i class="fa-solid fa-arrow-right-from-bracket"></i>
                            </div>
                            Logout
                        </a>
                    </li>
                </ul>
            </div>
            <div class="userpage-body-right container mt-3">
                <div class="image-user">
                    
                    <div class="image-logo-user">
                        <img src="/img/user.png" alt="" class="loge-user">
                        <input type="file" id="avt" class="hidden file_avt">
                        <label class="uploadImg" for="avt"><i class="fa-solid fa-arrow-up-from-bracket"></i></label>
                    </div>
                    <span  class="user-name">loading...</span>
                </div>
                <div class="userpage-body-below container">
                    
                    <div class="userpage-body-row">
                        <div class="userpage-introduce container">
                            <div class="userpage-introduce-sex">
                                <i class="fa-solid fa-user"></i>
                                <span class="user-male">loading...</span>
                            </div>
                            <div class="userpage-introduce-birthday">
                                <i class="fa-solid fa-cake-candles"></i>
                                <span class="user-dob">loading...</span>
                            </div>
                            <div class="userpage-introduce-edit">
                                <button type="button" onclick="editinformation()" class="btn btn-secondary">Edit Information</button>
                            </div>
                        </div>
                            <div class="userpageee container">
                                <div class="userpage-center-status container py-2">
                                    <div class="userpage-center-status1 container">
                                        <img src="/img/user.png" class="image-user1">
                                        <input type="search" class="form-control abcd post_content" id="floatingStatus1"
                                            placeholder="What's happenning?">
                                    </div>

                                    <div class="userpage-center-status2 pe-3 py-2">
                                       <input type="file" id="img" class="txtPhoto hidden post_file" >
                                        <label for="img">
                                            <img class="post_img" src="/img/img.png" alt="">
                                        </label>
                                        <button type="button" class="btn btn-primary button post_btn">Post</button>
                                    </div>
                                </div>
                                <div class="loading">
                                    <div class="spinner-border text-danger" role="status">
                                        <span class="sr-only">Loading...</span>
                                    </div>
                                </div>
                                <div class="posts_container"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="form-edit" id="form-edit">
        <div class="form2-edit">
            <div class="form2-edit-close">
                <button id="close" onclick="backuser()" class="buttonclose" type="button">X</button>
            </div>
            <div class="form2-edit-heading">
                <p class="form2-edit-name">Edit Information</p>
            </div>
            <div class="form2-edit-name">
                <input type="text" placeholder="First name" class="update_firstname">
                <input type="text" placeholder="Surname" class="update_surname" >
            </div>
            <div class="form2-edit-email">
                <input type="email" placeholder="Email address or phone number" class="update_email">
            </div>
            <div class="form2-date-birth">
                <label for="">Date of birth</label>
            </div>
            <div class="form2-date-selection">
                <div class="select-choice">
                    <select name="" class="date" id="">
                        <option value="1st">
                            1
                        </option>
                        <option value="2nd">
                            2
                        </option>
                        <option value="3rd">
                            3
                        </option>
                        <option value="4th">
                            4
                        </option>

                        <option value="5th">
                            5
                        </option>

                        <option value="6th">
                            6
                        </option>

                        <option value="7th">
                            7
                        </option>

                        <option value="8th">
                            8
                        </option>

                        <option value="9th">
                            9
                        </option>

                        <option value="10th">
                            10
                        </option>

                        <option value="11th">
                            11
                        </option>

                        <option value="12th">
                            12
                        </option>

                        <option value="13th">
                            13
                        </option>

                        <option value="14th">
                            14
                        </option>

                        <option value="15th">
                            15
                        </option>

                        <option value="16th">
                            16
                        </option>

                        <option value="17th">
                            17
                        </option>

                        <option value="18th">
                            18
                        </option>

                        <option value="19th">
                            19
                        </option>

                        <option value="20th">
                            20
                        </option>

                        <option value="21th">
                            21
                        </option>

                        <option value="22th">
                            22
                        </option>

                        <option value="23th">
                            23
                        </option>

                        <option value="24th">
                            24
                        </option>

                        <option value="25th">
                            25
                        </option>

                        <option value="26th">
                            26
                        </option>

                        <option value="27th">
                            27
                        </option>

                        <option value="28th">
                            28
                        </option>

                        <option value="29th">
                            29
                        </option>

                        <option value="30th">
                            30
                        </option>

                        <option value="31th">
                            31
                        </option>
                    </select>
                </div>
                <div class="select-choice">
                    <select class="month" name="" id="">

                        <option value="Jan">

                            Jan
                        </option>

                        <option value="Feb">

                            Feb
                        </option>

                        <option value="Mar">

                            Mar
                        </option>

                        <option value="Apr">

                            Apr
                        </option>

                        <option value="May">

                            May
                        </option>

                        <option value="Jun">

                            Jun
                        </option>

                        <option value="Jul">

                            Jul
                        </option>

                        <option value="Aug">

                            Aug
                        </option>

                        <option value="Sep">

                            Sep
                        </option>

                        <option value="Auc">

                            Auc
                        </option>

                        <option value="Nav">

                            Nav
                        </option>

                        <option value="Dec">

                            Dec
                        </option>


                    </select>
                </div>
                <div class="select-choice">
                    <select class="year" name="" id="">

                        <option value="1950">
                            1950
                        </option>

                        <option value="1951">
                            1951
                        </option>

                        <option value="1952">
                            1952
                        </option>

                        <option value="1953">
                            1953
                        </option>

                        <option value="1954">
                            1954
                        </option>

                        <option value="1955">
                            1955
                        </option>

                        <option value="1956">
                            1956
                        </option>

                        <option value="1957">
                            1957
                        </option>

                        <option value="1958">
                            1958
                        </option>

                        <option value="1959">
                            1959
                        </option>

                        <option value="1960">
                            1960
                        </option>

                        <option value="1961">
                            1961
                        </option>

                        <option value="1962">
                            1962
                        </option>

                        <option value="1963">
                            1963
                        </option>

                        <option value="1964">
                            1964
                        </option>

                        <option value="1965">
                            1965
                        </option>

                        <option value="1966">
                            1966
                        </option>

                        <option value="1967">
                            1967
                        </option>

                        <option value="1968">
                            1968
                        </option>

                        <option value="1969">
                            1969
                        </option>

                        <option value="1970">
                            1970
                        </option>

                        <option value="1971">
                            1971
                        </option>

                        <option value="1972">
                            1972
                        </option>

                        <option value="1973">
                            1973
                        </option>

                        <option value="1974">
                            1974
                        </option>

                        <option value="1975">
                            1975
                        </option>

                        <option value="1976">
                            1976
                        </option>

                        <option value="1977">
                            1977
                        </option>

                        <option value="1978">
                            1978
                        </option>

                        <option value="1979">
                            1979
                        </option>

                        <option value="1980">
                            1980
                        </option>

                        <option value="1981">
                            1981
                        </option>

                        <option value="1982">
                            1982
                        </option>

                        <option value="1983">
                            1983
                        </option>

                        <option value="1984">
                            1984
                        </option>

                        <option value="1985">
                            1985
                        </option>

                        <option value="1986">
                            1986
                        </option>

                        <option value="1987">
                            1987
                        </option>

                        <option value="1988">
                            1988
                        </option>

                        <option value="1989">
                            1989
                        </option>

                        <option value="1990">
                            1990
                        </option>

                        <option value="1991">
                            1991
                        </option>

                        <option value="1992">
                            1992
                        </option>

                        <option value="1993">
                            1993
                        </option>

                        <option value="1994">
                            1994
                        </option>

                        <option value="1995">
                            1995
                        </option>

                        <option value="1996">
                            1996
                        </option>

                        <option value="1997">
                            1997
                        </option>

                        <option value="1998">
                            1998
                        </option>

                        <option value="1999">
                            1999
                        </option>

                        <option value="2000">
                            2000
                        </option>

                        <option value="2001">
                            2001
                        </option>

                        <option value="2002">
                            2002
                        </option>

                        <option value="2003">
                            2003
                        </option>

                        <option value="2004">
                            2004
                        </option>

                        <option value="2005">
                            2005
                        </option>

                        <option value="2006">
                            2006
                        </option>

                        <option value="2007">
                            2007
                        </option>

                        <option value="2008">
                            2008
                        </option>

                        <option value="2009">
                            2009
                        </option>

                        <option value="2010">
                            2010
                        </option>

                        <option value="2011">
                            2011
                        </option>

                        <option value="2012">
                            2012
                        </option>

                        <option value="2013">
                            2013
                        </option>

                        <option value="2014">
                            2014
                        </option>

                        <option value="2015">
                            2015
                        </option>

                        <option value="2016">
                            2016
                        </option>

                        <option value="2017">
                            2017
                        </option>

                        <option value="2018">
                            2018
                        </option>

                        <option value="2019">
                            2019
                        </option>

                        <option value="2020">
                            2020
                        </option>
                        <option value="2021">
                            2021
                        </option>
                        <option value="2022">
                            2022
                        </option>

                    </select>
                </div>
            </div>
            <div class="form2-gender">
                <label for="">Gender</label>
            </div>
            <div class="form2-gender-choice">
                <div class="form2-gender-name">
                    <label class="form-check-label" for="inlineRadio1">Male</label>
                    <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio1"
                        value="Male">
                </div>
                <div class="form2-gender-name">
                    <label class="form-check-label" for="inlineRadio2">Female</label>
                    <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio2"
                        value="Female">
                </div>
                <div class="form2-gender-name">
                    <label class="form-check-label" for="inlineRadio3">Custom</label>
                    <input class="form-check-input" type="radio" name="inlineRadioOptions" id="inlineRadio3"
                        value="Custom">
                </div>
            </div>
            <div class="form2-edit-button">
                <button class="update_save">Save</button>
                <p class="update_alert hidden" style="color: #4caf50; text-align: center">User updated</p>
            </div>
        </div>

    </div>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"
        integrity="sha384-ka7Sk0Gln4gmtz2MlQnikT1wXgYsOg+OMhuP+IlRH9sENBO0LRn5q+8nbTov4+1p"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.10.2/dist/umd/popper.min.js"
        integrity="sha384-7+zCNj/IqJ95wo16oMtfsKbZ9ccEh31eOz1HGyDuCQ6wgnyJNSYdrPa03rtR1zdB"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.min.js"
        integrity="sha384-QJHtvGhmr9XOIpI6YVutG+2QOK9T+ZnN4kzFN1RtK3zEFEIsxhlmWl5/YESvpZ13"
        crossorigin="anonymous"></script>
    <script>
        const user_name = document.querySelector('.user-name');
        const user_male = document.querySelector('.user-male');
        const id = localStorage.getItem('userId');
        const user_dob = document.querySelector('.user-dob');
        const user_post_name = document.querySelector('.user-post-name');
        const logoutBtn = document.querySelector('.logout-btn');
        const file_avt = document.querySelector('.file_avt');
        const loading = document.querySelector('.loading')
        const user_avt = document.querySelector('.loge-user');
        let user_posting_avatar = document.querySelector('.image-user1');
        const post_file = document.querySelector('.post_file');
        //tạo biến global để sử dụng trên nhiều functions
        let file;
        let userData;
        post_file.addEventListener('change', (e) => {
            postFile = file = e.target.files[0];
        })
        //hiển thị thông báo
        const noti_alert = document.querySelector('.noti_alert');
        if(id && id != undefined){
            fetch('http://localhost:8080/notifications', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    userId: id
                })
            }).then(notiData => {
                return notiData.json();
            }).then(notiResponses => {
                //hiển thị số thông báo
                noti_alert.textContent = notiResponses.length;
            })
        }
        //cập nhật thông tin người dùng
        const update_firstname = document.querySelector('.update_firstname');
        const update_surname =  document.querySelector('.update_surname');
        const update_email = document.querySelector('.update_email');
        const update_gender = document.querySelectorAll('.form-check-input');
        const update_save = document.querySelector('.update_save');
        const dateSelect = document.querySelector('.date');
        const monthSelect = document.querySelector('.month');
        const yearSelect = document.querySelector('.year');
        update_save.addEventListener('click', () => {
            const firstName = update_firstname.value;
            const surName = update_surname.value;
            const email = update_email.value;
            const dateOfBirth = `${dateSelect.value} ${monthSelect.value} ${yearSelect.value}`;
            let gender = '';
            update_gender.forEach((e,i) => {
                e.checked ? gender = e.value : null
            })
            console.log({
                firstName,
                surName,
                email,
                dateOfBirth,
                gender
            })
            fetch('http://localhost:8080/userupdate', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    firstName,
                    surName,
                    email,
                    dateOfBirth,
                    gender,
                    id
                })
            }).then(data => {
                return data.json();
            }).then(response => {
                console.log(response)
            }).catch(err => {
                console.log(err);
            })
        })
        file_avt.addEventListener('change', () => {
            let file = file_avt.files[0];
            //tạo mới một form data:
            const dataForm = new FormData();
            //thêm thời gian vào trước tên file để đảm bảo tên file ko bị trùng lặp:
            const fileName = file ? Date.now() + file.name: '';
            dataForm.append("name", fileName);
            dataForm.append("file", file);
            //tải ảnh lên server:
            fetch("http://localhost:8080/upload", {
                method: 'POST',
                body: dataForm
            }).then(data => {
                return data.json()
            }).then(responses => {
                fetch('http://localhost:8080/avatar', {
                    method: 'POST',
                    headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({imagePath: fileName, userID: id})
                }).then(d => {
                    return d.json();
                }).then(res => {
                    window.location.reload();
                }).catch(err => {
                    console.log(err);
                })
            }).catch(err => {
                console.log(err);
            })
        })
        //lấy dữ liệu về các bài đăng:
        const posts_container = document.querySelector('.posts_container')
        function getAllPosts(){
            //lấy dữ liệu tất cả người dùng:
            fetch('http://localhost:8080/users', {
                method: 'POST',
            })
            .then(dataa => {
                return dataa.json();
            }).then(res => {
                users = res;
                //sau khi có dữ liệu người dùng thì lấy dữ liệu của tất cả post:
                fetch('http://localhost:8080/posts', {
                method: 'POST'
                }).then(data => {
                    return data.json();
                }).then(response => {
                    posts = response;
                    //ẩn spinner khi load hết dữ liệu:
                    loading.style.display = 'none';
                    let postID;
                    let currentUserID = `'${id}'`
                    //lọc ra những post là của chủ sở hữu
                    response.filter(p => p.userId === id).map(post => {
                        postID = `'${post._id}'`;
                        let curentUser = users?.find(user => user._id === id);
                        user_posting_avatar.src = curentUser === undefined ? '/img/user.png': `/img/${curentUser.avatar}`;
                        console.log(user_posting_avatar)
                        let postOwner = users?.find(user => user._id === post.userId);
                        let HTMLcomments = '';
                        post.comments.map(comment => {
                            const commentedUser = users.find(user => user._id === comment.userID);
                            HTMLcomments += `<div class="post_comments">
                                <div class="post_comment_left">
                                    <img src="/img/${commentedUser?.avatar}" class="comment_img">
                                </div>
                                <div class="post_comment_right">
                                    <div class="post_comment_owner">${commentedUser?.firstName} ${commentedUser?.surName}</div>
                                    <div class="post_comment_content">${comment.comment}</div>
                                </div>
                            </div>`
                        })
                        let html = `<div class="homepage-center-image postss">
                        <div class="homepage-center-post container py-2 posts_ct">
                            <div class="homepage-center-post1 container">
                                <div>
                                    <img src="/img/${postOwner.avatar}" class="img-user">
                                    <label class="ten post_user">${postOwner?.firstName} ${postOwner?.surName}</label>
                                </div>
                                <button type="button" class="btn btn-light bacham">...</button>
                            </div>
                            <div class="box-setting container">
                                
                            </div>
                            <div class="post_title">
                                <p>${post.content}</p>
                            </div>
                            <div class="homepage-center-picture container post_img_container">
                                <img src="/img/${post.image}" class="post_img">
                            </div>
                            <div class="homepage-center-post2 pe-3 py-2">
                                <button type="button" class="btn btn-secondary button-post">Comment</button>
                                <button type="button" class="btn btn-secondary button-post">Report Sighting</button>
                                <button type="button" class="btn btn-secondary button-post">Share</button>
                            </div>
                            <div  class="comments_container">
                                ${HTMLcomments}
                            </div>
                            <div class="homepage-center-comment container">
                                <img src="${curentUser ? '/img/'+curentUser.avatar :'/img/user.png'}" class="img-comment">
                                <input onChange={commentChangeHandler(this)} type="search" class="form-control comment" id="floatingStatus" placeholder="Write a comment...">
                                <i onClick={commentHandler(${postID},${currentUserID})} class="fa-solid fa-paper-plane comment_icon"></i>
                            </div>

                        </div>
                    
                    </div>`
                        posts_container.insertAdjacentHTML("afterbegin", html);
                    })
                }).catch(err => {
                    console.log(err);
                })
            }).catch(err => {
                console.log(err)
            })
        }
        getAllPosts();
        //đăng xuất bằng cách xóa id lưu trên localstorage và điều hướng ng dùng về trang chủ:
        logoutBtn.addEventListener('click', function(){
            localStorage.removeItem('userId');
            window.location.replace('/');
        })
        //nếu chưa có id người dùng đc lưu trên localstorage thì là ng dùng chưa đăng nhập, nên ta lại điều hướng người dùng về trang login
        if(!id){
            window.location.replace('/login');
        }
        //nếu có id, gửi id về server và kiểm tra:
        fetch('http://localhost:8080/user', {
            method: 'POST',
            headers: {
                'Accept': 'application/json',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({id: id})
        }).then(data => {
            //nếu id lưu trên localstorage bị sai:
            if(data.status === 401){
                localStorage.removeItem('userId');
                window.location.replace('/login');
            }
            //chuyển dữ liệu về dạng json
            return data.json();
        }).then(data => {
            //sau khi load xong dữ liệu người dùng thì ta sẽ hiển thị dữ liệu ra giao diện:
            userData = data;
            user_avt.src = "/img/"+data.avatar;
            user_name.textContent = `${data.firstName} ${data.surName}`;
            user_male.textContent = data.gender;
            user_dob.textContent = data.dob;
            
            update_firstname.value = data.firstName;
            update_email.value = data.email;
            update_surname.value = data.surName;
        }).catch(err => {
            //nếu có lỗi, chuyển ng dùng về trang login
            console.log(err)
            //window.location.replace('/login');
        })

        //đăng bài
        const postBtn = document.querySelector('.post_btn');
        const post_content = document.querySelector('.post_content');
        postBtn.addEventListener('click', () => {
            fetch('http://localhost:8080/user', {
                method: 'POST',
                headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({id: id})
            }).then(data => {
                //nếu id lưu trên localstorage bị sai:
                if(data.status === 401){
                    localStorage.removeItem('userId');
                    window.location.replace('/login');
                }
                //chuyển dữ liệu về dạng json
                return data.json();
            }).then(data => {
                //tạo mới một form data:
                const dataForm = new FormData();
                //thêm thời gian vào trước tên file để đảm bảo tên file ko bị trùng lặp:
                const fileName = file ? Date.now() + file.name: '';
                dataForm.append("name", fileName);
                dataForm.append("file", file);
                //lấy nội dung bài đăng mà người dùng nhập vào:
                const post_ct = post_content.value;
                //tải ảnh lên server:
                fetch("http://localhost:8080/upload", {
                    method: 'POST',
                    body: dataForm
                }).then(data => {
                    return data.json();
                }).then(response => {
                    //sau khi đã tải ảnh lên, tiếp tục tải nội dung bài viết
                    const tags = post_ct.split("#").slice(1).map(t => t.trim());
                    const newPost = {
                        content: post_ct,
                        image: fileName,
                        userId: id,
                        tags: tags
                    }
                    fetch('http://localhost:8080/post', {
                        method: 'POST',
                        headers: {
                            'Accept': 'application/json',
                            'Content-Type': 'application/json'
                        },
                        body:JSON.stringify(newPost)
                    }).then(data => {
                        return data.json();
                    }).then(res => {
                        //up post xong rồi thì load lại post:
                        post_content.value ='';
                        file = null;
                        getAllPosts();
                    }).catch(err => {
                        console.log(err);
                    })
                })
            }).catch(err => {
                //nếu có lỗi, chuyển ng dùng về trang login
                console.log(err)
                //window.location.replace('/login');
            })
        })
    </script>
</body>
</html>